<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Digital Panopticon - Keyword Art</title>

  <!-- Pretendard -->
  <link
    rel="stylesheet"
    as="style"
    crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/pretendardvariable-gov.min.css"
  />

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <style>
    :root{
      --bg:#171717;
      --text:#ffffff;
      --accent:#ff5a1f;
      --maxw: 430px;

      --chip-fill: rgba(255,255,255,0.14);
      --chip-stroke: rgba(255,255,255,0.18);
    }

    *{ box-sizing: border-box; }
    html, body{
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: "Pretendard Variable","Pretendard",Pretendard,-apple-system,BlinkMacSystemFont,
        "Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{ color: inherit; text-decoration: none; }

    .page{
      height: 100svh;
      display: flex;
      justify-content: center;
    }

    .container{
      width: min(100%, var(--maxw));
      height: 100svh;
      display: flex;
      flex-direction: column;
    }

    header{
      display: flex;
      align-items: center;
      gap: 8px;
      padding:
        calc(18px + env(safe-area-inset-top))
        20px
        0;
      flex-shrink: 0;
      z-index: 5;
    }

    .back{
      font-size: 20px;
      color: var(--accent);
      line-height: 1;
    }

    .header-title{
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: rgba(255,255,255,0.92);
    }

    .header-spacer{
      height: 18px;
      flex-shrink: 0;
    }

    .stage{
      position: relative;
      flex: 1;
      margin: 0 20px calc(16px + env(safe-area-inset-bottom));
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      touch-action: none;
    }

    .hint{
      position: absolute;
      left: 14px;
      bottom: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      letter-spacing: -0.01em;
      user-select: none;
      pointer-events: none;
      z-index: 2;
    }

    .debug{
      position: absolute;
      left: 12px;
      top: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 12px;
      line-height: 1.35;
      color: rgba(255,255,255,0.85);
      z-index: 3;
      white-space: pre-line;
      user-select: none;
      pointer-events: none;
    }

    canvas{ display: block; }
  </style>
</head>

<body>
  <main class="page">
    <section class="container">
      <header>
        <a href="./archive1.html" class="back" aria-label="Îí§Î°úÍ∞ÄÍ∏∞">‚Üê</a>
        <div class="header-title" id="pageTitle">Keyword Art</div>
      </header>
      <div class="header-spacer"></div>

      <div class="stage" id="stage">
        <div class="debug" id="debug">loading...</div>
        <div class="hint">drag the words</div>
      </div>
    </section>
  </main>

  <script>
    const debugEl = document.getElementById("debug");
    const stageEl = document.getElementById("stage");
    const titleEl = document.getElementById("pageTitle");

    function setDebug(msg){ debugEl.textContent = msg; }

    // ‚úÖ URLÏóêÏÑú Í¥ÄÎûåÍ∞ù Í≥†Ïú†Î≤àÌò∏ Í∞ÄÏ†∏Ïò§Í∏∞
    const params = new URLSearchParams(location.search);
    const visitorId = params.get("vid") || "unknown";
    titleEl.textContent = "No." + visitorId;

    // ‚úÖ ÎçîÎØ∏ ÌÇ§ÏõåÎìú(ÎÇòÏ§ëÏóê FirebaseÎ°ú ÍµêÏ≤¥)
    const DUMMY_KEYWORDS = [
      "ÏïåÍ≥†Î¶¨Ï¶ò","Ï∂îÏ≤ú","Í∞êÏãú","Ï∂îÏ†Å","ÎèÑÏ≤≠",
      "Í∞úÏù∏Ï†ïÎ≥¥","Îç∞Ïù¥ÌÑ∞","Í∏∞Î°ù","Î°úÍ∑∏","Ìå®ÌÑ¥",
      "ÏòàÏ∏°","ÌîÑÎ°úÌååÏùºÎßÅ","ÌïÑÌÑ∞Î≤ÑÎ∏î","Ìé∏Ìñ•","ÌÅ¥Î¶≠",
      "Ïä§ÌÅ¨Î°§","ÏãúÏÑ†","Í¥ëÍ≥†","Ï∑®Ìñ•","ÌîºÎìú"
    ];

    // üî• TODO: Firebase Î∂ôÏù¥Î©¥ Ïó¨Í∏∞Îßå Î∞îÍæ∏Î©¥ Îê®
    async function getKeywords(vid){
      // vidÎ°ú DB Ï°∞Ìöå -> keywords array return
      return DUMMY_KEYWORDS;
    }

    window.addEventListener("error", (e) => {
      setDebug("‚ùå JS Error\n" + (e.message || "unknown"));
    });

    function init(){
      if (!window.Matter){
        setDebug("‚ùå Matter.js Î°úÎìú Ïã§Ìå®\nCDN Ï∞®Îã®/ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏");
        return;
      }

      const {
        Engine, Render, Runner,
        Bodies, Body, Composite,
        Mouse, MouseConstraint, Events
      } = Matter;

      const stageW = stageEl.clientWidth;
      const stageH = stageEl.clientHeight;

      if (stageW < 10 || stageH < 10){
        setDebug("‚ùå stage ÌÅ¨Í∏∞ Ïù¥ÏÉÅ\nw=" + stageW + " h=" + stageH);
        return;
      }

      setDebug("‚úÖ Matter OK\nstage: " + stageW + "√ó" + stageH + "\nloading keywords...");

      const engine = Engine.create();
      engine.gravity.y = 1.05;

      const render = Render.create({
        element: stageEl,
        engine,
        options: {
          width: stageW,
          height: stageH,
          wireframes: false,
          background: "transparent",
          pixelRatio: Math.min(window.devicePixelRatio || 1, 2)
        }
      });

      Render.run(render);
      const runner = Runner.create();
      Runner.run(runner, engine);

      // Walls
      let walls = [];
      function buildWalls(){
        walls.forEach(w => Composite.remove(engine.world, w));
        walls = [];

        const w = stageEl.clientWidth;
        const h = stageEl.clientHeight;
        const thick = 60;

        const floor = Bodies.rectangle(w/2, h + thick/2, w + thick*2, thick, { isStatic:true, render:{ visible:false }});
        const ceil  = Bodies.rectangle(w/2, -thick/2, w + thick*2, thick, { isStatic:true, render:{ visible:false }});
        const left  = Bodies.rectangle(-thick/2, h/2, thick, h + thick*2, { isStatic:true, render:{ visible:false }});
        const right = Bodies.rectangle(w + thick/2, h/2, thick, h + thick*2, { isStatic:true, render:{ visible:false }});

        walls.push(floor, ceil, left, right);
        Composite.add(engine.world, walls);
      }
      buildWalls();

      // Drag
      const mouse = Mouse.create(render.canvas);
      const mouseConstraint = MouseConstraint.create(engine, {
        mouse,
        constraint: { stiffness: 0.18, damping: 0.12, render: { visible:false } }
      });
      Composite.add(engine.world, mouseConstraint);
      render.mouse = mouse;
      render.canvas.style.touchAction = "none";

      // Chips
      const chips = [];

      function textWidthApprox(text, fontSize=14){
        const base = fontSize * 0.62;
        return Math.max(72, Math.min(220, Math.round(text.length * base + 36)));
      }

      function createChip(text, x, y){
        const fontSize = 14;
        const w = textWidthApprox(text, fontSize);
        const h = 42;

        const body = Bodies.rectangle(x, y, w, h, {
          restitution: 0.25,
          friction: 0.18,
          frictionAir: 0.02,
          density: 0.0016,
          chamfer: { radius: 22 },
          render: {
            fillStyle: getComputedStyle(document.documentElement).getPropertyValue("--chip-fill").trim(),
            strokeStyle: getComputedStyle(document.documentElement).getPropertyValue("--chip-stroke").trim(),
            lineWidth: 1
          }
        });

        body.plugin = { labelText: text };
        chips.push(body);
        return body;
      }

      async function spawn(){
        const keywords = (await getKeywords(visitorId)).slice(0, 24);

        // Í∏∞Ï°¥ Î∞îÎîî Ï†úÍ±∞(Ïû¨Ìò∏Ï∂ú ÎåÄÎπÑ)
        chips.splice(0, chips.length);
        Composite.clear(engine.world, false);
        buildWalls();
        Composite.add(engine.world, mouseConstraint);

        const w = stageEl.clientWidth;

        keywords.forEach((k, i) => {
          const x = 50 + Math.random() * (w - 100);
          const y = 40 + i * 10;
          const b = createChip(k, x, y);
          Composite.add(engine.world, b);
          Body.applyForce(b, b.position, { x: (Math.random()-0.5)*0.002, y: 0.002 });
        });

        setDebug("No." + visitorId + "\nkeywords: " + keywords.length);
      }

      // Draw text on bodies
      Events.on(render, "afterRender", () => {
        const ctx = render.context;
        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.font = "700 14px Pretendard Variable, Pretendard, sans-serif";

        for (const b of chips){
          const p = b.position;
          const a = b.angle;
          const t = b.plugin?.labelText ?? "";
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(a);
          ctx.fillText(t, 0, 0);
          ctx.restore();
        }
        ctx.restore();
      });

      // Resize
      let resizeTimer = null;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          Render.stop(render);

          render.options.width = stageEl.clientWidth;
          render.options.height = stageEl.clientHeight;
          render.canvas.width = Math.floor(stageEl.clientWidth * render.options.pixelRatio);
          render.canvas.height = Math.floor(stageEl.clientHeight * render.options.pixelRatio);
          render.canvas.style.width = stageEl.clientWidth + "px";
          render.canvas.style.height = stageEl.clientHeight + "px";

          buildWalls();
          Render.run(render);

          spawn();
        }, 120);
      });

      spawn();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
